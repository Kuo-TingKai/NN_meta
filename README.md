# C++ Metaprogramming for NN Compilation

[English](README_EN.md) | **ä¸­æ–‡**

é€™æ˜¯ä¸€å€‹å±•ç¤ºå¦‚ä½•ä½¿ç”¨ C++ Metaprogramming æŠ€è¡“ä¾†å¯¦ç¾ç¥ç¶“ç¶²è·¯ç·¨è­¯å™¨çš„ç°¡å–®å¯åŸ·è¡Œç¯„ä¾‹å°ˆæ¡ˆã€‚

## ğŸ“š ç›¸é—œæ–‡æª”

- ğŸ“– [C++ æ ¸å¿ƒæŠ€è¡“ Cheat Sheet](CXX_CHEATSHEET.md) - è©³ç´°çš„ C++ æŠ€è¡“åƒè€ƒ
- ğŸ“Š [Benchmark æ¯”è¼ƒå ±å‘Š](benchmark_comparison_report.md) - æ€§èƒ½æ¯”è¼ƒåˆ†æ

## å°ˆæ¡ˆæ¦‚è¿°

æœ¬å°ˆæ¡ˆæ¼”ç¤ºäº†ä»¥ä¸‹ C++ Metaprogramming æŠ€è¡“åœ¨ NN ç·¨è­¯å™¨ä¸­çš„æ‡‰ç”¨ï¼š

1. **Template Metaprogramming (T-MP)**: ç”¨æ–¼å‰µå»ºå‹åˆ¥å®‰å…¨çš„å¼µé‡é‹ç®—
2. **Expression Templates**: ç”¨æ–¼å„ªåŒ–å¼µé‡è¡¨é”å¼ï¼Œé¿å…è‡¨æ™‚ç‰©ä»¶
3. **Constexpr**: ç”¨æ–¼ç·¨è­¯æ™‚è¨ˆç®—å’Œå„ªåŒ–
4. **å‹åˆ¥ç³»çµ±**: åœ¨ç·¨è­¯æ™‚é€²è¡Œå½¢ç‹€æª¢æŸ¥å’Œæ¨å°
5. **ç·¨è­¯æ™‚æ ¸å¿ƒç”Ÿæˆ**: æ ¹æ“šå¼µé‡å½¢ç‹€ç”Ÿæˆå„ªåŒ–çš„ç¨‹å¼ç¢¼

## å°ˆæ¡ˆçµæ§‹

```
nn_meta/
â”œâ”€â”€ CMakeLists.txt          # CMake æ§‹å»ºé…ç½®
â”œâ”€â”€ README.md               # æœ¬æ–‡ä»¶
â”œâ”€â”€ CXX_CHEATSHEET.md       # C++ æ ¸å¿ƒæŠ€è¡“å¿«é€Ÿåƒè€ƒè¡¨
â”œâ”€â”€ benchmark_comparison_report.md  # Benchmark æ¯”è¼ƒå ±å‘Š
â”œâ”€â”€ run_benchmarks.sh       # Benchmark åŸ·è¡Œè…³æœ¬
â”œâ”€â”€ include/                # é ­æ–‡ä»¶ç›®éŒ„
â”‚   â”œâ”€â”€ tensor.hpp          # å¼µé‡é¡åˆ¥ï¼ˆä½¿ç”¨ T-MPï¼‰
â”‚   â”œâ”€â”€ expression_template.hpp  # è¡¨é”å¼æ¨¡æ¿
â”‚   â”œâ”€â”€ nn_compiler.hpp      # NN ç·¨è­¯å™¨å·¥å…·
â”‚   â””â”€â”€ benchmark.hpp        # Benchmark å·¥å…·
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.cpp            # ä¸»ç¨‹å¼å’Œç¯„ä¾‹
â”‚   â””â”€â”€ benchmark_cpp.cpp   # C++ benchmark ç¨‹å¼
â””â”€â”€ benchmarks/             # Benchmark è…³æœ¬ç›®éŒ„
    â”œâ”€â”€ benchmark_pytorch.py    # PyTorch benchmark
    â””â”€â”€ compare_benchmarks.py   # æ¯”è¼ƒå ±å‘Šç”Ÿæˆå™¨
```

## ç·¨è­¯å’ŒåŸ·è¡Œ

### å‰ç½®éœ€æ±‚

- C++20 æˆ–æ›´é«˜ç‰ˆæœ¬çš„ç·¨è­¯å™¨ï¼ˆGCC 10+, Clang 10+, MSVC 2019+ï¼‰
- CMake 3.15 æˆ–æ›´é«˜ç‰ˆæœ¬
- Python 3.6+ï¼ˆç”¨æ–¼ benchmark æ¯”è¼ƒï¼Œå¯é¸ï¼‰
- PyTorchï¼ˆç”¨æ–¼ benchmark æ¯”è¼ƒï¼Œå¯é¸ï¼‰

### ç·¨è­¯æ­¥é©Ÿ

```bash
# å‰µå»ºæ§‹å»ºç›®éŒ„
mkdir build
cd build

# é…ç½®å°ˆæ¡ˆ
cmake ..

# ç·¨è­¯
cmake --build .

# åŸ·è¡Œ
./NNMetaProgramming
```

æˆ–è€…ä½¿ç”¨å–®ä¸€å‘½ä»¤ï¼š

```bash
mkdir -p build && cd build && cmake .. && cmake --build . && ./NNMetaProgramming
```

### ç·¨è­¯ Benchmark ç¨‹å¼

```bash
cd build
cmake --build . --target benchmark_cpp
./benchmark_cpp
```

## åŠŸèƒ½å±•ç¤º

### 1. Template Metaprogramming: å‹åˆ¥å®‰å…¨çš„å¼µé‡

ä½¿ç”¨ Template Metaprogramming å‰µå»ºåœ¨ç·¨è­¯æ™‚å°±çŸ¥é“å½¢ç‹€çš„å¼µé‡ï¼š

```cpp
Tensor<float, 2, 3> tensor_a{1.0f, 2.0f, 3.0f, 4.0f, 5.0f, 6.0f};
// å½¢ç‹€ [2, 3] åœ¨ç·¨è­¯æ™‚ç¢ºå®šï¼Œå‹åˆ¥ç³»çµ±ä¿è­‰å‹åˆ¥å®‰å…¨
```

### 2. Expression Templates: å„ªåŒ–çš„è¡¨é”å¼

ä½¿ç”¨è¡¨é”å¼æ¨¡æ¿é¿å…å‰µå»ºè‡¨æ™‚ç‰©ä»¶ï¼š

```cpp
auto expr_result = expr(a) + expr(b);
// ä¸æœƒå‰µå»ºè‡¨æ™‚çš„å¼µé‡ç‰©ä»¶ï¼Œç›´æ¥åœ¨è¨ˆç®—æ™‚æ±‚å€¼
```

### 3. ç·¨è­¯æ™‚æ ¸å¿ƒç”Ÿæˆ

æ ¹æ“šå¼µé‡å¤§å°åœ¨ç·¨è­¯æ™‚é¸æ“‡æœ€å„ªçš„å¯¦ç¾ï¼š

```cpp
auto result = matmul(mat_a, mat_b);
// å°æ–¼å°çŸ©é™£ï¼Œä½¿ç”¨å®Œå…¨å±•é–‹çš„è¿´åœˆ
// å°æ–¼å¤§çŸ©é™£ï¼Œä½¿ç”¨é‹è¡Œæ™‚è¿´åœˆ
```

### 4. Constexpr ç·¨è­¯æ™‚è¨ˆç®—

ä½¿ç”¨ `constexpr` åœ¨ç·¨è­¯æ™‚åŸ·è¡Œè¨ˆç®—ï¼š

```cpp
constexpr std::size_t fact_5 = constexpr_utils::factorial(5);
// åœ¨ç·¨è­¯æ™‚è¨ˆç®—ï¼Œé›¶é‹è¡Œæ™‚é–‹éŠ·
```

### 5. å‹åˆ¥å®‰å…¨çš„ç¥ç¶“ç¶²è·¯å±¤

å®šç¾©åœ¨ç·¨è­¯æ™‚å°±çŸ¥é“è¼¸å…¥è¼¸å‡ºå½¢ç‹€çš„å±¤ï¼š

```cpp
LinearLayer<float, 3, 2> layer;  // 3 è¼¸å…¥ -> 2 è¼¸å‡º
// å‹åˆ¥ç³»çµ±ä¿è­‰å½¢ç‹€åŒ¹é…
```

## C++ æ ¸å¿ƒæŠ€è¡“åƒè€ƒ

æœ¬å°ˆæ¡ˆä½¿ç”¨äº†å¤§é‡ç¾ä»£ C++ æŠ€è¡“ï¼Œè©³ç´°çš„æŠ€è¡“åƒè€ƒè«‹æŸ¥çœ‹ï¼š

ğŸ“– **[C++ æ ¸å¿ƒæŠ€è¡“ Cheat Sheet](CXX_CHEATSHEET.md)** | [English](CXX_CHEATSHEET_EN.md)

åŒ…å«ä»¥ä¸‹æŠ€è¡“çš„è©³ç´°èªªæ˜å’Œç¯„ä¾‹ï¼š
- Template Metaprogramming
- Constexpr èˆ‡ç·¨è­¯æ™‚è¨ˆç®—
- Variadic Templates
- Fold Expressions
- if constexpr
- Type Traits
- Expression Templates
- CRTP æ¨¡å¼
- Lambda è¡¨é”å¼
- ä»¥åŠå…¶ä»–ç¾ä»£ C++ ç‰¹æ€§

## æŠ€è¡“è¦é»

### Template Metaprogramming çš„å„ªå‹¢

1. **å‹åˆ¥å®‰å…¨**: ç·¨è­¯æ™‚æª¢æŸ¥å¼µé‡å½¢ç‹€åŒ¹é…
2. **é›¶é–‹éŠ·æŠ½è±¡**: ç·¨è­¯å™¨å¯ä»¥å®Œå…¨å„ªåŒ–æ‰æŠ½è±¡å±¤
3. **ç·¨è­¯æ™‚å„ªåŒ–**: æ ¹æ“šå½¢ç‹€ç”Ÿæˆæœ€å„ªåŒ–çš„ç¨‹å¼ç¢¼

### Expression Templates çš„å„ªå‹¢

1. **é¿å…è‡¨æ™‚ç‰©ä»¶**: è¡¨é”å¼åœ¨æ±‚å€¼æ™‚æ‰è¨ˆç®—ï¼Œä¸å‰µå»ºä¸­é–“å¼µé‡
2. **å»¶é²æ±‚å€¼**: å¯ä»¥å„ªåŒ–æ•´å€‹è¡¨é”å¼æ¨¹
3. **æ•ˆèƒ½æå‡**: æ¸›å°‘è¨˜æ†¶é«”åˆ†é…å’Œè¤‡è£½

### Constexpr çš„å„ªå‹¢

1. **ç·¨è­¯æ™‚è¨ˆç®—**: å¸¸æ•¸åœ¨ç·¨è­¯æ™‚è¨ˆç®—ï¼Œé›¶é‹è¡Œæ™‚é–‹éŠ·
2. **å‹åˆ¥æ¨å°**: ç·¨è­¯å™¨å¯ä»¥æ¨å°å‡ºæ›´å¤šè³‡è¨Šé€²è¡Œå„ªåŒ–
3. **å…ƒç·¨ç¨‹å¢å¼·**: ä½¿æ¨¡æ¿å…ƒç·¨ç¨‹æ›´å¼·å¤§å’Œæ˜“ç”¨

## Benchmark æ¯”è¼ƒ

æœ¬å°ˆæ¡ˆåŒ…å«èˆ‡ä¸»æµæ·±åº¦å­¸ç¿’æ¡†æ¶ï¼ˆPyTorchï¼‰çš„ benchmark æ¯”è¼ƒåŠŸèƒ½ã€‚

ğŸ“Š **[è©³ç´° Benchmark å ±å‘Š](benchmark_comparison_report.md)** | [English](benchmark_comparison_report_EN.md)

### é‹è¡Œ Benchmark

#### æ–¹æ³• 1: ä½¿ç”¨è‡ªå‹•åŒ–è…³æœ¬ï¼ˆæ¨è–¦ï¼‰

```bash
./run_benchmarks.sh
```

é€™å€‹è…³æœ¬æœƒï¼š
1. è‡ªå‹•æ§‹å»º C++ benchmark ç¨‹å¼
2. é‹è¡Œ C++ benchmark
3. é‹è¡Œ PyTorch benchmark
4. ç”Ÿæˆæ¯”è¼ƒå ±å‘Š

#### æ–¹æ³• 2: æ‰‹å‹•é‹è¡Œ

```bash
# 1. æ§‹å»º C++ benchmark
cd build
cmake --build . --target benchmark_cpp

# 2. é‹è¡Œ C++ benchmark
./benchmark_cpp

# 3. é‹è¡Œ PyTorch benchmark
cd ../benchmarks
python3 benchmark_pytorch.py

# 4. ç”Ÿæˆæ¯”è¼ƒå ±å‘Šï¼ˆéœ€è¦æ‰‹å‹•è§£æè¼¸å‡ºï¼‰
```

### Benchmark å…§å®¹

Benchmark åŒ…å«ä»¥ä¸‹é‹ç®—çš„æ¯”è¼ƒï¼š

1. **çŸ©é™£ä¹˜æ³• (MatMul)**
   - å°çŸ©é™£ (4x4)
   - ä¸­çŸ©é™£ (32x32)
   - å¤§çŸ©é™£ (128x128)

2. **ReLU æ¿€æ´»å‡½æ•¸**
   - å°å¼µé‡ (16 å…ƒç´ )
   - ä¸­å¼µé‡ (1024 å…ƒç´ )
   - å¤§å¼µé‡ (4096 å…ƒç´ )

3. **ç·šæ€§å±¤å‰å‘å‚³æ’­**
   - å°å±¤ (64 -> 32)
   - ä¸­å±¤ (256 -> 128)
   - å¤§å±¤ (1024 -> 512)

4. **å…ƒç´ ç´šé‹ç®—**
   - å¼µé‡åŠ æ³•

### Benchmark çµæœè§£è®€

Benchmark æœƒè¼¸å‡ºä»¥ä¸‹çµ±è¨ˆè³‡è¨Šï¼š
- **Mean**: å¹³å‡åŸ·è¡Œæ™‚é–“ï¼ˆå¾®ç§’ï¼‰
- **Median**: ä¸­ä½æ•¸åŸ·è¡Œæ™‚é–“ï¼ˆå¾®ç§’ï¼‰
- **StdDev**: æ¨™æº–å·®
- **Min/Max**: æœ€å°/æœ€å¤§åŸ·è¡Œæ™‚é–“

æ¯”è¼ƒå ±å‘Šæœƒé¡¯ç¤ºï¼š
- å„æ¡†æ¶çš„åŸ·è¡Œæ™‚é–“
- ç›¸å°é€Ÿåº¦æå‡ï¼ˆSpeedupï¼‰
- æ€§èƒ½åˆ†æ

### æ³¨æ„äº‹é …

1. **ç·¨è­¯å™¨å„ªåŒ–**: C++ benchmark ä½¿ç”¨ `-O3` å„ªåŒ–ï¼Œé€™å¯èƒ½å°è‡´æŸäº›å°é‹ç®—è¢«å®Œå…¨å„ªåŒ–æ‰
2. **PyTorch ç‰ˆæœ¬**: ç¢ºä¿å®‰è£äº† PyTorchï¼ˆ`pip install torch`ï¼‰
3. **ç³»çµ±è² è¼‰**: å»ºè­°åœ¨ç³»çµ±è² è¼‰è¼ƒä½æ™‚é‹è¡Œ benchmark ä»¥ç²å¾—æº–ç¢ºçµæœ
4. **CPU vs GPU**: PyTorch benchmark æœƒè‡ªå‹•æª¢æ¸¬æ˜¯å¦ä½¿ç”¨ GPUï¼ŒC++ ç‰ˆæœ¬ç›®å‰åƒ…ä½¿ç”¨ CPU

## èˆ‡ NN ç·¨è­¯å™¨çš„é—œä¿‚

é€™äº›æŠ€è¡“åœ¨å¯¦éš›çš„ NN ç·¨è­¯å™¨ï¼ˆå¦‚ TVMã€TensorFlow XLAï¼‰ä¸­è¢«å»£æ³›ä½¿ç”¨ï¼š

1. **é«˜æ•ˆæ ¸å¿ƒç”Ÿæˆ**: æ ¹æ“šæ¨¡å‹å±¤çš„ç‰¹å®šå½¢ç‹€ç”Ÿæˆé«˜åº¦å„ªåŒ–çš„ CUDA/OpenCL æ ¸å¿ƒ
2. **å¼µé‡é‹ç®—å„ªåŒ–**: ä½¿ç”¨è¡¨é”å¼æ¨¡æ¿å„ªåŒ–è¤‡é›œçš„å¼µé‡é‹ç®—éˆ
3. **å‹åˆ¥ç³»çµ±**: åœ¨ç·¨è­¯æ™‚æª¢æŸ¥æ¨¡å‹çš„æ­£ç¢ºæ€§ï¼Œé¿å…é‹è¡Œæ™‚éŒ¯èª¤
4. **ç·¨è­¯æ™‚å„ªåŒ–**: ä½¿ç”¨ constexpr å’Œæ¨¡æ¿ç‰¹åŒ–é€²è¡Œç·¨è­¯æ™‚å„ªåŒ–

## æœªä¾†æ–¹å‘

éš¨è‘— C++ æ¨™æº–çš„æ¼”é€²ï¼Œä»¥ä¸‹åŠŸèƒ½å°‡é€²ä¸€æ­¥å¢å¼· NN ç·¨è­¯å™¨é–‹ç™¼ï¼š

- **Reflection (C++23/26)**: å…è¨±åœ¨ç·¨è­¯æ™‚æª¢æŸ¥å’Œæ“ä½œç¨‹å¼ç¢¼çµæ§‹
- **Metaclasses (C++26/29)**: å…è¨±å®šç¾©é¡åˆ¥çš„å‰µå»ºæ–¹å¼ï¼Œç°¡åŒ–å±¤å®šç¾©
- **å¢å¼·çš„ Constexpr**: æ›´å¼·å¤§çš„ç·¨è­¯æ™‚è¨ˆç®—èƒ½åŠ›

## åƒè€ƒè³‡æ–™

- [C++ Template Metaprogramming](https://en.cppreference.com/w/cpp/language/templates)
- [Expression Templates](https://en.wikipedia.org/wiki/Expression_templates)
- [Constexpr](https://en.cppreference.com/w/cpp/language/constexpr)
- [TVM Compiler Stack](https://tvm.apache.org/)

## æˆæ¬Š

æœ¬å°ˆæ¡ˆåƒ…ä¾›å­¸ç¿’å’Œç¤ºç¯„ç”¨é€”ã€‚

